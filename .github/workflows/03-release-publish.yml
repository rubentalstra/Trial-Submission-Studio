name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_macos:
        description: 'Build macOS'
        type: boolean
        default: true
      build_linux:
        description: 'Build Linux'
        type: boolean
        default: true
      build_windows:
        description: 'Build Windows'
        type: boolean
        default: false  # Disabled until signing keys available

# Default values for tag-triggered builds
# To re-enable a platform, change its value to 'true'
env:
  DEFAULT_BUILD_MACOS: 'true'
  DEFAULT_BUILD_LINUX: 'true'
  DEFAULT_BUILD_WINDOWS: 'false'  # Set to 'true' when Windows signing keys are available

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  attestations: write
  actions: read

jobs:
  # Extract version and determine which platforms to build
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      build_number: ${{ steps.version.outputs.BUILD_NUMBER }}
      build_macos: ${{ steps.config.outputs.build_macos }}
      build_linux: ${{ steps.config.outputs.build_linux }}
      build_windows: ${{ steps.config.outputs.build_windows }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history for commit count

      - name: Extract version and build number
        id: version
        env:
          REF: ${{ github.ref }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          echo "VERSION=${REF#refs/tags/}" >> $GITHUB_OUTPUT

          # Calculate build number: TSS-{run_number}.{commit_count}
          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "BUILD_NUMBER=TSS-${RUN_NUMBER}.${COMMIT_COUNT}" >> $GITHUB_OUTPUT

      - name: Determine build configuration
        id: config
        run: |
          # Use workflow_dispatch inputs if available, otherwise use defaults
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "build_macos=${{ inputs.build_macos }}" >> $GITHUB_OUTPUT
            echo "build_linux=${{ inputs.build_linux }}" >> $GITHUB_OUTPUT
            echo "build_windows=${{ inputs.build_windows }}" >> $GITHUB_OUTPUT
          else
            echo "build_macos=${{ env.DEFAULT_BUILD_MACOS }}" >> $GITHUB_OUTPUT
            echo "build_linux=${{ env.DEFAULT_BUILD_LINUX }}" >> $GITHUB_OUTPUT
            echo "build_windows=${{ env.DEFAULT_BUILD_WINDOWS }}" >> $GITHUB_OUTPUT
          fi

      - name: Log build configuration
        run: |
          echo "Build configuration:"
          echo "  macOS: ${{ steps.config.outputs.build_macos }}"
          echo "  Linux: ${{ steps.config.outputs.build_linux }}"
          echo "  Windows: ${{ steps.config.outputs.build_windows }}"

  # Validate required secrets for enabled platforms
  validate:
    name: Validate Secrets
    needs: [ prepare ]
    uses: ./.github/workflows/01-release-validate.yml
    with:
      validate_macos: ${{ needs.prepare.outputs.build_macos == 'true' }}
      validate_windows: ${{ needs.prepare.outputs.build_windows == 'true' }}
    secrets: inherit

  # Build for enabled platforms
  build-macos:
    name: Build macOS
    needs: [ prepare, validate ]
    if: needs.prepare.outputs.build_macos == 'true'
    uses: ./.github/workflows/02-release-build-macos.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      build_number: ${{ needs.prepare.outputs.build_number }}
    secrets: inherit

  build-windows:
    name: Build Windows
    needs: [ prepare, validate ]
    if: needs.prepare.outputs.build_windows == 'true'
    uses: ./.github/workflows/02-release-build-windows.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      build_number: ${{ needs.prepare.outputs.build_number }}
    secrets: inherit

  build-linux:
    name: Build Linux
    needs: [ prepare, validate ]
    if: needs.prepare.outputs.build_linux == 'true'
    uses: ./.github/workflows/02-release-build-linux.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      build_number: ${{ needs.prepare.outputs.build_number }}
    secrets: inherit

  # Create GitHub Release with all artifacts
  publish:
    name: Publish Release
    needs: [ prepare, build-macos, build-windows, build-linux ]
    # Run if at least one build was enabled and all enabled builds succeeded
    if: |
      always() &&
      (needs.prepare.outputs.build_macos == 'true' ||
       needs.prepare.outputs.build_linux == 'true' ||
       needs.prepare.outputs.build_windows == 'true') &&
      (needs.build-macos.result == 'success' || needs.build-macos.result == 'skipped') &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped') &&
      (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped') &&
      !(needs.build-macos.result == 'skipped' &&
        needs.build-windows.result == 'skipped' &&
        needs.build-linux.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f || ls -la artifacts/

      - name: Generate artifact attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "artifacts/*"

      - name: Determine prerelease
        id: prerelease
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          if [[ "$VERSION" == *"-"* ]]; then
            echo "PRERELEASE=true" >> $GITHUB_OUTPUT
          else
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ needs.prepare.outputs.version }}"
          draft: false
          prerelease: ${{ steps.prerelease.outputs.PRERELEASE }}
          generate_release_notes: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
