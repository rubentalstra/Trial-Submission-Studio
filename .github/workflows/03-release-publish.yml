# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_macos:
        description: "Build macOS"
        type: boolean
        default: true
      build_linux:
        description: "Build Linux"
        type: boolean
        default: true
      build_windows:
        description: "Build Windows"
        type: boolean
        default: true

# Default values for tag-triggered builds
env:
  DEFAULT_BUILD_MACOS: "true"
  DEFAULT_BUILD_LINUX: "true"
  DEFAULT_BUILD_WINDOWS: "true"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  attestations: write
  actions: read

jobs:
  # ============================================================
  # Prepare Release
  # Extract version and determine which platforms to build
  # ============================================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      build_number: ${{ steps.version.outputs.BUILD_NUMBER }}
      build_macos: ${{ steps.config.outputs.build_macos }}
      build_linux: ${{ steps.config.outputs.build_linux }}
      build_windows: ${{ steps.config.outputs.build_windows }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version and build number
        id: version
        env:
          REF: ${{ github.ref }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          set -euo pipefail

          VERSION="${REF#refs/tags/}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

          # Calculate build number: TSS-{run_number}.{commit_count}
          COMMIT_COUNT=$(git rev-list --count HEAD)
          BUILD_NUMBER="TSS-${RUN_NUMBER}.${COMMIT_COUNT}"
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_OUTPUT

          echo "=== Release Information ==="
          echo "Version: ${VERSION}"
          echo "Build Number: ${BUILD_NUMBER}"

      - name: Determine build configuration
        id: config
        run: |
          # Use workflow_dispatch inputs if available, otherwise use defaults
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "build_macos=${{ inputs.build_macos }}" >> $GITHUB_OUTPUT
            echo "build_linux=${{ inputs.build_linux }}" >> $GITHUB_OUTPUT
            echo "build_windows=${{ inputs.build_windows }}" >> $GITHUB_OUTPUT
          else
            echo "build_macos=${{ env.DEFAULT_BUILD_MACOS }}" >> $GITHUB_OUTPUT
            echo "build_linux=${{ env.DEFAULT_BUILD_LINUX }}" >> $GITHUB_OUTPUT
            echo "build_windows=${{ env.DEFAULT_BUILD_WINDOWS }}" >> $GITHUB_OUTPUT
          fi

      - name: Log build configuration
        run: |
          echo "=== Build Configuration ==="
          echo "  macOS:   ${{ steps.config.outputs.build_macos }}"
          echo "  Linux:   ${{ steps.config.outputs.build_linux }}"
          echo "  Windows: ${{ steps.config.outputs.build_windows }}"

  # ============================================================
  # Validate Secrets
  # Check that required secrets are configured
  # ============================================================
  validate:
    name: Validate Secrets
    needs: [ prepare ]
    uses: ./.github/workflows/01-release-validate.yml
    with:
      validate_macos: ${{ needs.prepare.outputs.build_macos == 'true' }}
      validate_windows: ${{ needs.prepare.outputs.build_windows == 'true' }}
    secrets: inherit

  # ============================================================
  # Platform Builds
  # Build for each enabled platform
  # ============================================================
  build-macos:
    name: Build macOS
    needs: [ prepare, validate ]
    if: needs.prepare.outputs.build_macos == 'true'
    uses: ./.github/workflows/02-release-build-macos.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      build_number: ${{ needs.prepare.outputs.build_number }}
    secrets: inherit

  build-linux:
    name: Build Linux
    needs: [ prepare, validate ]
    if: needs.prepare.outputs.build_linux == 'true'
    uses: ./.github/workflows/02-release-build-linux.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      build_number: ${{ needs.prepare.outputs.build_number }}
    secrets: inherit

  build-windows:
    name: Build Windows
    needs: [ prepare, validate ]
    if: needs.prepare.outputs.build_windows == 'true'
    uses: ./.github/workflows/02-release-build-windows.yml
    with:
      version: ${{ needs.prepare.outputs.version }}
      build_number: ${{ needs.prepare.outputs.build_number }}
    secrets: inherit

  # ============================================================
  # Publish Release
  # Combine artifacts and create GitHub Release
  # ============================================================
  publish:
    name: Publish Release
    needs: [ prepare, build-macos, build-windows, build-linux ]
    if: |
      always() &&
      (needs.prepare.outputs.build_macos == 'true' ||
       needs.prepare.outputs.build_linux == 'true' ||
       needs.prepare.outputs.build_windows == 'true') &&
      (needs.build-macos.result == 'success' || needs.build-macos.result == 'skipped') &&
      (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped') &&
      (needs.build-linux.result == 'success' || needs.build-linux.result == 'skipped') &&
      !(needs.build-macos.result == 'skipped' &&
        needs.build-windows.result == 'skipped' &&
        needs.build-linux.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f -exec ls -lh {} \; 2>/dev/null || ls -la artifacts/

      - name: Generate artifact attestations
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "artifacts/*"

      - name: Determine prerelease status
        id: prerelease
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          if [[ "$VERSION" == *"-alpha"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-rc"* ]]; then
            echo "PRERELEASE=true" >> $GITHUB_OUTPUT
            echo "This is a pre-release version"
          else
            echo "PRERELEASE=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ needs.prepare.outputs.version }}"
          draft: false
          prerelease: ${{ steps.prerelease.outputs.PRERELEASE }}
          generate_release_notes: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo "=== Release Summary ==="
          echo "Version: ${VERSION}"
          echo "Pre-release: ${{ steps.prerelease.outputs.PRERELEASE }}"
          echo ""
          echo "Artifacts uploaded:"
          find artifacts -type f -name "*.tar.gz" -o -name "*.zip" -o -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" 2>/dev/null | sort
          echo ""
          echo "Note: SHA256 digests are automatically provided by GitHub for all release assets"
