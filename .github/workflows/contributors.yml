name: Update Contributors

on:
  workflow_dispatch:
  schedule:
    # Run monthly on the 1st at 02:03 UTC
    - cron: "3 2 1 * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-contributors:
    name: Update Contributors
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Update contributors file
        uses: minicli/action-contributors@v3.3
        env:
          CONTRIB_REPOSITORY: rubentalstra/Trial-Submission-Studio
          CONTRIB_OUTPUT_FILE: CONTRIBUTORS.md
          CONTRIB_IGNORE: "github-actions[bot],renovate-bot,dependabot[bot]"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet CONTRIBUTORS.md; then
            echo "No changes to commit"
            exit 0
          fi

          BRANCH="contributors/update-$(date +%Y-%m)"

          # Create branch from main if it doesn't exist
          gh api repos/${{ github.repository }}/git/refs \
            -f ref="refs/heads/$BRANCH" \
            -f sha="$(gh api repos/${{ github.repository }}/git/ref/heads/main --jq '.object.sha')" \
            2>/dev/null || true

          # Get current file SHA on branch (if exists)
          FILE_SHA=$(gh api "repos/${{ github.repository }}/contents/CONTRIBUTORS.md?ref=$BRANCH" --jq '.sha' 2>/dev/null || echo "")

          # Create signed commit via Contents API
          if [ -n "$FILE_SHA" ]; then
            gh api repos/${{ github.repository }}/contents/CONTRIBUTORS.md -X PUT \
              -f message="docs: update contributors list" \
              -f content="$(base64 -i CONTRIBUTORS.md)" \
              -f branch="$BRANCH" \
              -f sha="$FILE_SHA"
          else
            gh api repos/${{ github.repository }}/contents/CONTRIBUTORS.md -X PUT \
              -f message="docs: update contributors list" \
              -f content="$(base64 -i CONTRIBUTORS.md)" \
              -f branch="$BRANCH"
          fi

          # Create PR if it doesn't exist
          gh pr list --head "$BRANCH" --json number --jq '.[0].number' | grep -q . || \
            gh pr create --title "docs: update contributors list" \
              --body "Automated monthly update of the contributors list." \
              --label "automated"
