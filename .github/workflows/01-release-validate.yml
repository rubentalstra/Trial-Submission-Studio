name: Validate Release Secrets

on:
  workflow_call:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Signing Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check macOS secrets (REQUIRED)
        env:
          APPLE_DEVELOPER_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
          APPLE_CODESIGN_IDENTITY: ${{ secrets.APPLE_CODESIGN_IDENTITY }}
          APPLE_NOTARIZATION_APPLE_ID: ${{ secrets.APPLE_NOTARIZATION_APPLE_ID }}
          APPLE_NOTARIZATION_APP_PASSWORD: ${{ secrets.APPLE_NOTARIZATION_APP_PASSWORD }}
          APPLE_DEVELOPER_TEAM_ID: ${{ secrets.APPLE_DEVELOPER_TEAM_ID }}
          CI_KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD }}
        run: |
          missing=""

          [ -z "$APPLE_DEVELOPER_CERTIFICATE_P12_BASE64" ] && missing="$missing APPLE_DEVELOPER_CERTIFICATE_P12_BASE64"
          [ -z "$APPLE_DEVELOPER_CERTIFICATE_PASSWORD" ] && missing="$missing APPLE_DEVELOPER_CERTIFICATE_PASSWORD"
          [ -z "$APPLE_CODESIGN_IDENTITY" ] && missing="$missing APPLE_CODESIGN_IDENTITY"
          [ -z "$APPLE_NOTARIZATION_APPLE_ID" ] && missing="$missing APPLE_NOTARIZATION_APPLE_ID"
          [ -z "$APPLE_NOTARIZATION_APP_PASSWORD" ] && missing="$missing APPLE_NOTARIZATION_APP_PASSWORD"
          [ -z "$APPLE_DEVELOPER_TEAM_ID" ] && missing="$missing APPLE_DEVELOPER_TEAM_ID"
          [ -z "$CI_KEYCHAIN_PASSWORD" ] && missing="$missing CI_KEYCHAIN_PASSWORD"

          if [ -n "$missing" ]; then
            echo "::error::Missing required macOS secrets:$missing"
            echo ""
            echo "Please configure the following secrets in GitHub Settings > Secrets and variables > Actions:"
            echo "  - APPLE_DEVELOPER_CERTIFICATE_P12_BASE64: Base64-encoded .p12 certificate"
            echo "  - APPLE_DEVELOPER_CERTIFICATE_PASSWORD: Password for the .p12 file"
            echo "  - APPLE_CODESIGN_IDENTITY: Full signing identity (e.g., 'Developer ID Application: Name (TEAM_ID)')"
            echo "  - APPLE_NOTARIZATION_APPLE_ID: Apple ID email for notarization"
            echo "  - APPLE_NOTARIZATION_APP_PASSWORD: App-specific password for notarization"
            echo "  - APPLE_DEVELOPER_TEAM_ID: 10-character Team ID"
            echo "  - CI_KEYCHAIN_PASSWORD: Random password for temporary CI keychain"
            echo ""
            echo "See docs/src/development/macos-signing.md for setup instructions."
            exit 1
          fi

          echo "All macOS secrets configured"

      - name: Check Windows secrets (REQUIRED)
        env:
          SIGNPATH_API_TOKEN: ${{ secrets.SIGNPATH_API_TOKEN }}
          SIGNPATH_ORGANIZATION_ID: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
          SIGNPATH_PROJECT_SLUG: ${{ secrets.SIGNPATH_PROJECT_SLUG }}
          SIGNPATH_SIGNING_POLICY_SLUG: ${{ secrets.SIGNPATH_SIGNING_POLICY_SLUG }}
        run: |
          missing=""

          [ -z "$SIGNPATH_API_TOKEN" ] && missing="$missing SIGNPATH_API_TOKEN"
          [ -z "$SIGNPATH_ORGANIZATION_ID" ] && missing="$missing SIGNPATH_ORGANIZATION_ID"
          [ -z "$SIGNPATH_PROJECT_SLUG" ] && missing="$missing SIGNPATH_PROJECT_SLUG"
          [ -z "$SIGNPATH_SIGNING_POLICY_SLUG" ] && missing="$missing SIGNPATH_SIGNING_POLICY_SLUG"

          if [ -n "$missing" ]; then
            echo "::error::Missing required Windows secrets:$missing"
            echo ""
            echo "Please configure the following secrets in GitHub Settings > Secrets and variables > Actions:"
            echo "  - SIGNPATH_API_TOKEN: API token with submitter permissions from SignPath dashboard"
            echo "  - SIGNPATH_ORGANIZATION_ID: Your SignPath organization ID"
            echo "  - SIGNPATH_PROJECT_SLUG: Project identifier from SignPath"
            echo "  - SIGNPATH_SIGNING_POLICY_SLUG: Signing policy name (typically 'release-signing')"
            echo ""
            echo "See docs/src/development/windows-signing.md for SignPath setup instructions."
            exit 1
          fi

          echo "All Windows SignPath secrets configured"
