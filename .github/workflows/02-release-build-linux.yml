name: Build Linux

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  APP_NAME: trial-submission-studio

jobs:
  build:
    name: Build ${{ matrix.artifact-name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            artifact-name: linux-x86_64
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
            artifact-name: linux-arm64
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6

      - uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libssl-dev libxdo-dev libfuse2
          version: 1.1

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.artifact-name }}"
          cache-on-failure: true

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create tarball
        env:
          VERSION: ${{ inputs.version }}
        run: |
          mkdir -p release
          cp "target/${{ matrix.target }}/release/${APP_NAME}" release/
          tar -czvf "${APP_NAME}-${VERSION}-${{ matrix.target }}.tar.gz" -C release .

      - name: Create AppImage
        env:
          VERSION: ${{ inputs.version }}
        run: |
          # Download and extract appimagetool (extract to avoid FUSE issues in CI)
          wget -q "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-$(uname -m).AppImage" -O appimagetool
          chmod +x appimagetool
          ./appimagetool --appimage-extract
          mv squashfs-root appimagetool-extracted

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy binary
          cp "target/${{ matrix.target }}/release/${APP_NAME}" AppDir/usr/bin/

          # Copy desktop file and icon
          cp packaging/linux/${APP_NAME}.desktop AppDir/usr/share/applications/
          cp packaging/linux/${APP_NAME}.png AppDir/usr/share/icons/hicolor/256x256/apps/

          # Create symlinks in AppDir root (required by AppImage)
          ln -s usr/bin/${APP_NAME} AppDir/AppRun
          ln -s usr/share/applications/${APP_NAME}.desktop AppDir/${APP_NAME}.desktop
          ln -s usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png AppDir/${APP_NAME}.png

          # Build AppImage using extracted appimagetool
          ARCH=$(uname -m) ./appimagetool-extracted/AppRun AppDir "${APP_NAME}-${VERSION}-${{ matrix.target }}.AppImage"

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            ${{ env.APP_NAME }}-${{ inputs.version }}-${{ matrix.target }}.tar.gz
            ${{ env.APP_NAME }}-${{ inputs.version }}-${{ matrix.target }}.AppImage
          if-no-files-found: error
