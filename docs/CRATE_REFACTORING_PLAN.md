# Crate Refactoring Plan

This document outlines what to simplify, remove, and consolidate in each crate.
The goal is **less complexity, less overhead, less duplicated code, clean and
simple**.

## Quick Summary

| Crate            | Status      | Actions                                                        |
| ---------------- | ----------- | -------------------------------------------------------------- |
| `sdtm-model`     | ‚úÖ Clean    | Minor: remove unused `DatasetMetadata` fields                  |
| `sdtm-standards` | ‚ö†Ô∏è Moderate | Remove `assumptions/` module (duplicate of validator.rs logic) |
| `sdtm-validate`  | üî¥ Major    | **DELETE** `validator.rs` (603 lines of duplicate code)        |
| `sdtm-core`      | ‚ö†Ô∏è Moderate | Simplify `ct_utils.rs`, remove `datetime.rs` if unused         |
| `sdtm-ingest`    | ‚úÖ Clean    | Keep as-is                                                     |
| `sdtm-map`       | ‚úÖ Clean    | Keep as-is                                                     |
| `sdtm-report`    | ‚úÖ Clean    | Keep as-is                                                     |
| `sdtm-cli`       | ‚úÖ Clean    | Keep as-is                                                     |
| `sdtm-xpt`       | ‚úÖ Clean    | Keep as-is                                                     |

---

## `sdtm-model` (Clean ‚úÖ)

**Lines of code:** ~350\
**Status:** Clean and well-organized

### Current Structure

- `ct.rs` - Clean CT model: `Codelist`, `CtTerm`, `CtCatalog`, `CtRegistry`,
  `ResolvedCodelist`
- `conformance.rs` - Simplified: `IssueSeverity`, `ConformanceIssue`,
  `ConformanceReport`
- `domain.rs` - Domain types: `DatasetClass`, `Variable`, `Domain`
- `mapping.rs` - Mapping types: `ColumnHint`, `MappingSuggestion`,
  `MappingConfig`
- `processing.rs` - Processing types: `OutputFormat`, `DomainResult`, etc.
- `lookup.rs` - `CaseInsensitiveLookup` utility
- `error.rs` - `SdtmError`, `Result`

### Recommended Actions

- [x] Already simplified `conformance.rs` (from ~216 to ~55 lines)
- [ ] **Minor:** Consider removing `DatasetMetadata` if unused elsewhere
- [ ] **Minor:** `domain.rs` has many helper methods on `DatasetClass` -
      evaluate if all are used

### No Action Needed

- CT model is clean and follows SDTM_CT_relationships.md
- Error types are minimal

---

## `sdtm-standards` (Moderate ‚ö†Ô∏è)

**Lines of code:** ~600+\
**Status:** Has duplicate rule generation logic

### Current Structure

- `ct_loader.rs` - Clean CT loader
- `loaders.rs` - Domain loading from CSV
- `xsl.rs` - XSL stylesheets
- `assumptions/` - **DUPLICATE** rule generation module
  - `mod.rs` - Module exports
  - `generator.rs` - `RuleGenerator`, `GeneratedRule`, `RuleSeverity`,
    `RuleContext`
  - `core.rs` - `CoreDesignation` enum

### üî¥ REMOVE: `assumptions/` module (329 lines)

**Why:** This duplicates logic that already exists in
`sdtm-validate/src/validator.rs`:

| `assumptions/generator.rs`  | `sdtm-validate/validator.rs` |
| --------------------------- | ---------------------------- |
| `RuleSeverity` enum         | `Severity` enum              |
| `GeneratedRule` struct      | `Issue` struct               |
| `generate_core_rules()`     | `check_core()`               |
| `generate_ct_rules()`       | `check_ct()`                 |
| `generate_datetime_rules()` | `check_format()`             |

**The `assumptions/` module:**

1. Generates rules that are then executed by `engine.rs`
2. But `validator.rs` already has the same logic inline
3. Creates unnecessary indirection

### Recommended Actions

- [ ] **DELETE** entire `assumptions/` folder
- [ ] Remove `RuleEngine` usage from `sdtm-validate/src/lib.rs`
- [ ] Use `Validator` directly (after consolidating, see `sdtm-validate`
      section)

---

## `sdtm-validate` (Major üî¥)

**Lines of code:** ~1500+\
**Status:** Has MAJOR duplication

### Current Structure

- `lib.rs` (473 lines) - Main validation functions, `ValidationContext`
- `validator.rs` (603 lines) - **DUPLICATE** `Validator`, `Issue`, `Severity`,
  `ValidationReport`
- `engine.rs` (307 lines) - `RuleEngine` for executing generated rules
- `cross_domain.rs` (~130 lines) - Cross-domain validation (simplified)

### üî¥ CRITICAL: Two parallel validation systems exist!

**System 1: `lib.rs` + `engine.rs`**

- Uses `ValidationContext` + `RuleEngine`
- Rules generated by `sdtm-standards/assumptions/`
- Returns `ConformanceReport` from `sdtm-model`

**System 2: `validator.rs`**

- Uses `Validator` struct
- Has inline validation logic
- Returns its own `ValidationReport` with `Issue` structs

### Type Duplication

| `sdtm-model/conformance.rs` | `validator.rs`     |
| --------------------------- | ------------------ |
| `IssueSeverity`             | `Severity`         |
| `ConformanceIssue`          | `Issue`            |
| `ConformanceReport`         | `ValidationReport` |

### Recommended Actions

**Option A: DELETE `validator.rs` entirely (RECOMMENDED)**

- [ ] Delete `validator.rs` (603 lines)
- [ ] Delete `engine.rs` (307 lines)
- [ ] Keep only `validate_domain()` in `lib.rs` which uses `ConformanceReport`
- [ ] Remove `assumptions/` module from `sdtm-standards`

**Total lines removed:** ~1200+ lines

**After cleanup, `sdtm-validate` becomes:**

```rust
// lib.rs (~200 lines)
pub mod cross_domain;

pub use cross_domain::{...};
pub use sdtm_model::{ConformanceIssue, ConformanceReport, IssueSeverity};

// Single validation function
pub fn validate_domain(domain: &Domain, df: &DataFrame, ctx: &ValidationContext) -> ConformanceReport {
    // CT-only validation (source of truth)
    // Core designation checks
    // Format checks
}
```

---

## `sdtm-core` (Moderate ‚ö†Ô∏è)

**Lines of code:** ~4000+\
**Status:** Large, some potential cleanup

### Current Structure

- `lib.rs` - 82 lines of re-exports (too many?)
- `ct_utils.rs` (542 lines) - CT resolution utilities
- `datetime.rs` (1844 lines!) - Date/time utilities
- `processor.rs` - Domain processing
- `domain_processors/` - Per-domain processors (20 files)
- `preprocess/` - Preprocessing rules
- `frame.rs`, `frame_builder.rs`, `frame_utils.rs` - DataFrame utilities
- And many more...

### Analysis

**`datetime.rs` (1844 lines)**

- Comprehensive ISO 8601 parsing
- Used for `--DTC` variable validation
- **Keep** - this is legitimate functionality

**`ct_utils.rs` (542 lines)**

- Many CT resolution functions
- Some overlap with `sdtm-model/ct.rs`

### Recommended Actions

- [ ] **Audit** `ct_utils.rs` for functions that duplicate CT registry
      functionality
- [ ] Move CT resolution logic to `sdtm-model/ct.rs` methods where appropriate
- [ ] Keep `datetime.rs` (needed for timing variable validation)
- [ ] Keep `domain_processors/` (per-domain logic is legitimate)
- [ ] Keep `preprocess/` (preprocessing is legitimate)

### Potential Removals in `ct_utils.rs`

These functions may duplicate CT registry methods:

- `is_valid_ct_value()` - use `CtRegistry::resolve()` directly
- `normalize_ct_value()` variants - consider simplifying
- `resolve_ct_*()` variants - too many entry points

---

## `sdtm-ingest` (Clean ‚úÖ)

**Lines of code:** ~500\
**Status:** Clean and focused

### Current Structure

- `csv_table.rs` - CSV reading
- `discovery.rs` - File discovery
- `polars_utils.rs` - Polars helpers
- `streaming.rs` - Large file handling
- `study_metadata.rs` - Metadata loading

### No Action Needed

- Single responsibility: ingest data from files
- Clean APIs

---

## `sdtm-map` (Clean ‚úÖ)

**Lines of code:** ~400\
**Status:** Clean and focused

### Current Structure

- `engine.rs` - Mapping engine
- `patterns.rs` - Synonym matching
- `repository.rs` - Mapping storage
- `utils.rs` - Utilities

### No Action Needed

- Single responsibility: column mapping
- Clean APIs

---

## `sdtm-report` (Clean ‚úÖ)

**Lines of code:** ~1000\
**Status:** Clean, single file

### Current Structure

- `lib.rs` - Output generation (XPT, Dataset-XML, Define-XML, SAS)

### No Action Needed

- Single responsibility: generate output files
- Well-organized

---

## `sdtm-cli` (Clean ‚úÖ)

**Lines of code:** ~800\
**Status:** Clean

### Current Structure

- `main.rs` - Entry point
- `cli.rs` - Argument parsing
- `commands.rs` - Command handlers
- `pipeline.rs` - Pipeline orchestration
- `summary.rs` - Output formatting
- `types.rs` - CLI types
- `logging.rs` - Log setup

### No Action Needed

- Clean separation of concerns

---

## `sdtm-xpt` (Clean ‚úÖ)

**Lines of code:** ~680\
**Status:** Clean, single file

### Current Structure

- `lib.rs` - XPT read/write

### No Action Needed

- Single responsibility: XPT format handling

---

## Critical Finding: Production vs Dead Code

### What the CLI Actually Uses (pipeline.rs)

```rust
// Line 37 - imports
use sdtm_validate::{
    CrossDomainValidationInput, ValidationContext, validate_cross_domain, validate_domains,
    write_conformance_report_json,
};

// Line 403 - validation call
let reports = validate_domains(&pipeline.standards, &frame_refs, &validation_ctx);
```

**This means:**

- ‚úÖ `validate_domains()` ‚Üí `validate_domain()` - USED IN PRODUCTION
- ‚úÖ `validate_cross_domain()` - USED IN PRODUCTION
- ‚úÖ `ValidationContext` - USED IN PRODUCTION
- ‚ùå `Validator` struct - DEAD CODE (only in validator.rs tests)
- ‚ùå `validate_domain_with_rules()` - DEAD CODE (only in tests)
- ‚ùå `RuleEngine` - DEAD CODE (only used by validate_domain_with_rules)
- ‚ùå `RuleGenerator` - DEAD CODE (only generates rules for RuleEngine)

### Safe to Delete (verified by grep search)

| File/Module                    | Usage                               | Status    |
| ------------------------------ | ----------------------------------- | --------- |
| `validator.rs`                 | Only internal `#[cfg(test)]` module | ‚ùå DELETE |
| `engine.rs`                    | Only `validate_domain_with_rules`   | ‚ùå DELETE |
| `assumptions/`                 | Only `RuleGenerator` for engine     | ‚ùå DELETE |
| `validate_domain_with_rules()` | Only tests                          | ‚ùå DELETE |

---

## Execution Order

### Phase 1: Remove Duplicate Validation (Biggest Win)

1. **DELETE** `sdtm-validate/src/validator.rs` (603 lines)
2. **DELETE** `sdtm-validate/src/engine.rs` (307 lines)
3. **DELETE** `sdtm-standards/src/assumptions/` folder (329 lines)
4. Update `sdtm-validate/src/lib.rs` to remove dead exports
5. Update `sdtm-standards/src/lib.rs` to remove assumptions exports

**Total: ~1200+ lines removed**

### Phase 2: Consolidate CT Utils

1. Audit `sdtm-core/src/ct_utils.rs` (542 lines)
2. Move essential methods to `sdtm-model/src/ct.rs`
3. Simplify or remove duplicate functions
4. Update imports across crates

**Estimate: ~200-300 lines removed**

### Phase 3: Minor Cleanup

1. Remove unused types in `sdtm-model/domain.rs`
2. Simplify `sdtm-core/src/lib.rs` re-exports

---

## Validation After Refactoring

Run after each phase:

```bash
cargo fmt
cargo clippy
cargo build
cargo test
```

---

## Summary

| Phase     | Action                      | Lines Removed    |
| --------- | --------------------------- | ---------------- |
| 1         | Delete duplicate validation | ~1200            |
| 2         | Consolidate CT utils        | ~200-300         |
| 3         | Minor cleanup               | ~50-100          |
| **Total** |                             | **~1500+ lines** |

The codebase will be:

- **Simpler**: One validation path, one CT model
- **Less duplicated**: No parallel type hierarchies
- **Cleaner**: Fewer re-exports, clearer APIs
